<!DOCTYPE html>
<html>
<head>
    <title>H·ªá Th·ªëng Gi√°m S√°t V√† ƒêi·ªÅu H∆∞·ªõng Pin NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS t√°ch ri√™ng -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="{{ url_for('static', filename='img/iuh.png') }}"
     alt        ="Solar Logo"
     cla            ss="header-logo">
            <h2>Khoa C√¥ng Ngh·ªá ƒêi·ªán T·ª≠</h2>
            <h1>H·ªá Th·ªëng Gi√°m S√°t V√† ƒêi·ªÅu H∆∞·ªõng Pin NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</h1>
            <p>GVHD: Ths Nguy·ªÖn VƒÉn Chi·∫øn</p>
            <p>Nguy·ªÖn Th√†nh Nguy√™n & D∆∞∆°ng Qu·ªëc Ki·ªát</p>

            <div class="user-info">
                <span>üë§ {{ username }}</span>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>

        <!-- Weather Panel -->
        <div class="weather-panel" id="weatherPanel">
            <div class="weather-current">
                <div class="weather-icon" id="weatherIcon">{{ weather.weather_icon }}</div>
                <div class="weather-info">
                    <div class="weather-temp" id="weatherTemp">{{ weather.temperature }}¬∞C</div>
                    <div class="weather-desc" id="weatherDesc">{{ weather.weather_desc }}</div>
                </div>
                <button onclick="updateWeather(event)" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer;">
                    üîÑ C·∫≠p nh·∫≠t
                </button>
            </div>

            <div class="weather-details">
                <div class="weather-detail-item">
                    <span class="weather-detail-icon">üíß</span>
                    <span>ƒê·ªô ·∫©m: <span id="weatherHumidity">--%</span></span>
                </div>
                <div class="weather-detail-item">
                    <span class="weather-detail-icon">üí®</span>
                    <span>Gi√≥: <span id="weatherWind">-- km/h</span></span>
                </div>
                <div class="weather-detail-item">
                    <span class="weather-detail-icon">‚òÅÔ∏è</span>
                    <span>M√¢y: <span id="weatherClouds">--%</span></span>
                </div>
                <div class="weather-detail-item">
                    <span class="weather-detail-icon">üåÖ</span>
                    <span>M·∫∑t tr·ªùi: <span id="weatherSunrise">--:--</span></span>
                </div>
            </div>

            <div class="weather-forecast">
                <div class="forecast-title">üìà D·ª± b√°o 12h ti·∫øp theo</div>
                <div class="forecast-list" id="weatherForecast">
                    <!-- Forecast items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="picoStatus"></div>
                <span>Tr·∫°ng Th√°i Pico</span>
            </div>
            <div class="status-item">
                <div class="status-dot online"></div>
                <span>Web Server</span>
            </div>
            <div class="status-item">
                <div class="status-dot online"></div>
                <span>C∆° S·ªü D·ªØ Li·ªáu</span>
            </div>
            <div class="status-item">
                <div class="status-dot online"></div>
                <span>User: {{ username }}</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="test-alert-btn" onclick="testSlackAlert(event)">
                üö® Ki·ªÉm Tra C·∫£nh B√°o Slack
            </button>
            <button class="test-report-btn" onclick="testSlackReport(event)">
                üìä Ki·ªÉm Tra B√°o C√°o Slack
            </button>
        </div>

        <!-- Tabs v·ªõi badge c·∫£nh b√°o -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('dashboard', event)">üìä Dashboard</button>
            <button class="tab-btn" onclick="openTab('history', event)">üìà L·ªãch S·ª≠</button>
            <button class="tab-btn" onclick="openTab('daily', event)">üìÖ Theo Ng√†y</button>
            <button class="tab-btn" onclick="openTab('reports', event)">üìã B√°o C√°o</button>
            <button class="tab-btn" onclick="openTab('alerts', event)" id="alertsTabBtn">
                üö® C·∫£nh B√°o
                <span id="alertsBadge" class="badge" style="display: none">0</span>
            </button>
            <button class="tab-btn" onclick="window.location.href='/users'">
                <i class="fas fa-users"></i> Qu·∫£n L√Ω Ng∆∞·ªùi D√πng
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard">
                <!-- Sensor Data Panel -->
                <div class="card">
                    <h2>üìä D·ªØ Li·ªáu C·∫£m Bi·∫øn</h2>
                    <div class="sensor-grid">
                        <div class="sensor-item">
                            <div class="sensor-label">G√≥c Xoay Tr√°i Ph·∫£i</div>
                            <div class="sensor-value" id="azimuthValue">--¬∞</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">G√≥c Xoay Tr√™n Xu·ªëng</div>
                            <div class="sensor-value" id="elevationValue">--¬∞</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">D√≤ng ƒêi·ªán</div>
                            <div class="sensor-value" id="currentValue">-- A</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">ƒêi·ªán √Åp</div>
                            <div class="sensor-value" id="voltageValue">-- V</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">C√¥ng Su·∫•t</div>
                            <div class="sensor-value" id="powerValue">-- W</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">Hi·ªáu Su·∫•t</div>
                            <div class="sensor-value" id="efficiencyValue">--%</div>
                        </div>
                    </div>

                    <!-- Battery Information Section -->
                    <h2 style="margin-top: 25px;">üîã Th√¥ng tin Pin 12V</h2>
                    <div class="battery-grid">
                        <div class="battery-item">
                            <div class="battery-icon">‚ö°</div>
                            <div class="sensor-label">ƒêi·ªán √°p Pin L∆∞u Tr·ªØ</div>
                            <div class="battery-value" id="batteryVoltageValue">-- V</div>
                            <div class="sensor-label">Tr·∫°ng th√°i</div>
                            <div id="batteryStatusText">--</div>
                        </div>
                        <div class="battery-item">
                            <div class="battery-icon">üîã</div>
                            <div class="sensor-label">Dung l∆∞·ª£ng Pin C√≤n L·∫°i</div>
                            <div class="battery-percentage" id="batterySocValue">--%</div>
                            <div class="battery-progress">
                                <div class="battery-progress-bar" id="batteryProgressBar"></div>
                            </div>
                            <div class="sensor-label" id="batteryCapacityText">-- / -- Ah</div>
                        </div>
                    </div>

                    <div class="last-update">
                        C·∫≠p Nh·∫≠t L·∫ßn Cu·ªëi: <span id="lastUpdate">--</span>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="card">
                    <h2>üéÆ B·∫£ng ƒêi·ªÅu Khi·ªÉn</h2>
                    <div class="control-panel">
                        <div class="mode-toggle">
                            <button class="toggle-btn active" id="autoBtn" onclick="sendControl('SET_MODE', 'AUTO')">T·ª± ƒê·ªông</button>
                            <button class="toggle-btn" id="manualBtn" onclick="sendControl('SET_MODE', 'MANUAL')">Th·ªß C√¥ng</button>
                        </div>

                        <div id="manualControls" style="display: none;">
                            <div class="slider-group">
                                <div class="slider-label">
                                    <span>G√≥c Xoay Tr√°i Ph·∫£i:</span>
                                    <span class="slider-value" id="azimuthSliderValue">90¬∞</span>
                                </div>
                                <input type="range" id="azimuthSlider" min="0" max="180" value="90" oninput="updateSlider('azimuth')">
                            </div>

                            <div class="slider-group">
                                <div class="slider-label">
                                    <span>G√≥c Xoay Tr√™n Xu·ªëng:</span>
                                    <span class="slider-value" id="elevationSliderValue">90¬∞</span>
                                </div>
                                <input type="range" id="elevationSlider" min="0" max="180" value="90" oninput="updateSlider('elevation')">
                            </div>

                            <button class="toggle-btn" onclick="sendManualAngles()" style="background: #48bb78; color: white;">
                                √Åp D·ª•ng G√≥c ƒê√£ ƒê·∫∑t
                            </button>
                        </div>

                        <div class="energy-toggle">
                            <span>Ch·∫ø ƒê·ªô Ti·∫øt Ki·ªám NƒÉng L∆∞·ª£ng:</span>
                            <label class="switch">
                                <input type="checkbox" id="energySavingToggle" onchange="sendControl('SET_ENERGY_MODE', this.checked)">
                                <span class="slider-round"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="card">
                <h2>üìà L·ªãch S·ª≠ D·ªØ Li·ªáu Theo D√≤ng Th·ªùi Gian</h2>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="changeChartType('power', event)">C√¥ng su·∫•t</button>
                    <button class="chart-btn" onclick="changeChartType('voltage', event)">ƒêi·ªán √°p</button>
                    <button class="chart-btn" onclick="changeChartType('current', event)">D√≤ng ƒëi·ªán</button>
                    <button class="chart-btn" onclick="changeChartType('efficiency', event)">Hi·ªáu su·∫•t</button>
                    <button class="chart-btn" onclick="changeChartType('battery_voltage', event)">ƒêi·ªán √°p Pin</button>
                    <button class="chart-btn" onclick="changeChartType('battery_soc', event)">% Pin</button>
                    <select id="timeRange" onchange="loadHistoryChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #e2e8f0;">
                        <option value="1">1 gi·ªù</option>
                        <option value="6">6 gi·ªù</option>
                        <option value="24" selected>24 gi·ªù</option>
                        <option value="168">1 tu·∫ßn</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="historyChart"></canvas>
                </div>
                <button onclick="loadHistoryChart()" style="margin-top: 15px; padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Refresh Chart
                </button>
            </div>
        </div>

        <!-- Daily Chart Tab -->
        <div id="daily" class="tab-content">
            <div class="card">
                <h2>üìÖ Bi·ªÉu ƒê·ªì Theo Ng√†y</h2>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="changeDailyChartType('power', event)">C√¥ng su·∫•t</button>
                    <button class="chart-btn" onclick="changeDailyChartType('voltage', event)">ƒêi·ªán √°p</button>
                    <button class="chart-btn" onclick="changeDailyChartType('current', event)">D√≤ng ƒëi·ªán</button>
                    <button class="chart-btn" onclick="changeDailyChartType('efficiency', event)">Hi·ªáu su·∫•t</button>
                    <button class="chart-btn" onclick="changeDailyChartType('battery_voltage', event)">ƒêi·ªán √°p Pin</button>
                    <button class="chart-btn" onclick="changeDailyChartType('battery_soc', event)">% Pin</button>
                    <select id="dateSelect" onchange="loadDailyChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #e2e8f0;">
                        <option value="">Ch·ªçn ng√†y...</option>
                    </select>
                    <button onclick="loadDailyChart()" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Xem bi·ªÉu ƒë·ªì
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
                <div style="margin-top: 15px; text-align: center; color: #666;">
                    <p>Hi·ªÉn th·ªã d·ªØ li·ªáu theo gi·ªù trong ng√†y</p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h2>üìã B√°o C√°o H·∫±ng Ng√†y</h2>
                <div id="reportsData">Loading...</div>
                <button onclick="loadReports()" style="margin-top: 15px; padding: 10px 20px; background: #48bb78; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Refresh Reports
                </button>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alerts" class="tab-content">
            <div class="card">
                <h2>üö® L·ªãch S·ª≠ C·∫£nh B√°o</h2>
                <div id="alertsHistory" class="alert-history">
                    Loading alerts history...
                </div>
                <div class="action-buttons">
                    <button onclick="loadAlertsHistory()" style="padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üîÑ T·∫£i l·∫°i
                    </button>
                    <button onclick="clearAlerts()" style="padding: 10px 20px; background: #e53e3e; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üóëÔ∏è X√≥a l·ªãch s·ª≠
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span class="toast-icon">üí°</span>
        <div class="toast-content">
            <div class="toast-title"></div>
            <div class="toast-message"></div>
        </div>
        <button class="toast-close" onclick="hideToast()">√ó</button>
    </div>

    

    <!-- LIBS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- JS t√°ch ri√™ng -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>
